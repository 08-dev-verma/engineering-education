### Integrating Razorpay in a React-Django(Django Rest Framework) Application

Razorpay is an Indian digital payment system that offers businesses online invoices, online payments, and financial management tools to help them grow their business on the web. The solution helps companies make it easy for buyers from anywhere in the world to pay for goods or services securely through their website or mobile application without having to worry about currency conversions or bank charges.

Before integrating the Razorpay payment gateway in your application, you should understand how the payment process flows. Below is a high-level representation of this:
![Razorpay Payment Flow](/engineering-education/react-django-razorpay-integration/razorpay-payment-flow.png)


The processes involved can be broken down into five simple steps:
- A customer selects the item to buy on your website/app.
- You create an order using the Razorpay instance in backend/server.
- You pass the order ID generated by the Razorpay instance together with the amount and currency to the checkout.
- Authenticating the payment in the server/back-end by verifying the signature returned by Razorpay upon a successful transaction.
- Confirm the payment on the Razorpay Dashboard.

### Pre-requisites
To follow along in this tutorial, you need to have the following:
- A basic understanding of the Django REST Framework and React.
- [Node.js](https://nodejs.org/en/download/) installed on your machine.
- A browser and a code editor.

### Goals
By the end of this tutorial you should be able to:
- Integrate the Razorpay payment gateway in your application.
- Work with React and Django REST Framework.
- Use [axios](https://www.npmjs.com/package/axios) to fetch and post data.

### Creating a Razorpay Account
Open the Razorpay [Sign up](https://dashboard.razorpay.com/signup?captcha=invisible) page and create an account.

After providing all the required information, you will be redirected to the dashboard.

Scroll down on the left sidebar and click on `Settings`. On the main content page, select `API Keys` and click on `Generate Test Key`.

![Razorpay Dashboard](/engineering-education/react-django-razorpay-integration/razorpay-dashboard.png)

Download the `Key Id` and `Key Secret` displayed on the modal by clicking on the `Download Key Details` button as they are only displayed once.

### Setting up the Front-end
Navigate to the directory of your choice on your computer and create a folder named `react-django-razorpay`. Open this folder in terminal and run the following command to create a React app named `client` with `yarn`.

```bash
yarn create react-app client
```

`cd` into the `client` folder open it in a code editor. The command below works if you have `VS Code` installed.

```bash
code .
```
Open the integrated terminal and run the command below to install `axios` as dependency. We will use it to perform requests to the server.
```bash 
yarn add axios
```

Next, open the `App.js` file and replace the existing code with the code provided below.

```js
import axios from 'axios';
import { useState, useEffect } from 'react'
import './App.css'
import logo from './logo.svg'

function App() {
    const [productDetails, setProductDetails] = useState()
    const [selectedItemAmount, setSelectedItemAmount] = useState()

    useEffect(() => {
        getProduct()
    }, [])

    const getProduct = () => {
        return axios
        .get(`https://fakestoreapi.com/products/${Math.floor(Math.random() * 10) + 11}`)
        .then((res) => {
            setProductDetails(res.data)
            setSelectedItemAmount((res.data.price * 75.61 * 100).toFixed(2))
        })
        .catch((err) => console.log(err))
    }

  return (
    <div className="App">
    {
      productDetails && (
        <div className="card">
          <img src={productDetails.image} alt="Denim Jeans" />
          <div className='details'>
            <h1>{productDetails.title.substring(0, 20) + "..."}</h1>
            <p className="price">{"â‚¹ " + (productDetails.price * 75.61).toFixed(2)}</p>
            <p>{productDetails.description.substring(0, 70) + "..."}</p>
            <button onClick={displayRazorpay}>BUY</button>
          </div>
        </div>
      )
    }
  </div> 
  );
}

export default App;
```
- In the above code snippet, we have two pieces of state:
    - `productDetails` - This holds the data fetched from the `fakestoreapi`.
    - `selectedItemAmount` - This holds the price of the item selected by the user. The price is sent to the server to create an order.

- We also have the `getProduct()` function that fetches a random item from the `fakestoreapi`. We use `axios` to make a `GET` request from the `fakestoreapi` and save the data returned to the `productDetails` state. Fetching a random product is made possible by the `Math.floor(Math.random() * 10) + 11` expression that returns a random number between 1 and 20.

- The `getProduct()` function is called once every time the page reloads. We achieve this using the `useEffect()` hook.

- We also use conditional rendering in the JSX to ensure that the product is only displayed if the `productDetails` state contains the required data.

- The price of the items fetched from the `fakestoreapi` is in USD so we multiply it by 75.61 to convert it to Indian Rupees.

- The `BUY` button calls the `displayRazorpay()` function when clicked. This function is discussed below.

Paste the following code outside(on top) of the `App()` function.

```js
function loadScript(src) {
	return new Promise((resolve) => {
		const script = document.createElement('script')
		script.src = src
		script.onload = () => {
			resolve(true)
		}
		script.onerror = () => {
			resolve(false)
		}
		document.body.appendChild(script)
	})
}
```
The above code creates and appends a script tag in the body of the HTML document using a [JavaScript Promise](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Promise). This is the `Razorpay checkout script` that does all the work behind the scenes. The script `src` will be passed from the fuction that calls it.


Paste in the code provided below under the `getProduct()` function. 
```js
async function displayRazorpay() {
		const res = await loadScript('https://checkout.razorpay.com/v1/checkout.js')

		if (!res) {
			alert('Failure loading the Razorpay SDK. PLease make sure you are connected to the internet')
			return
		}
    
    const orderData = await axios.post('http://127.0.0.1:8000/createOrder/', {
      amount: selectedItemAmount
    })

    const { amount, currency, order_id } = orderData.data

    
		const options = {
            key: "rzp_test_7nUVLAb4PYi83N", // Enter the Key ID generated from the Dashboard
            amount: amount.toString(),
            currency: currency,
            name: "Test Company",
            description: "Test Transaction",
            image: logo,
            order_id: order_id,
            handler: async function (response) {
                const razorpay_paymentId = response.razorpay_payment_id
                const razorpay_orderId = response.razorpay_order_id
                const razorpay_signature = response.razorpay_signature

                const res = await axios.post('http://127.0.0.1:8000/verifySignature/', {
                  razorpay_paymentId,
                  razorpay_orderId,
                  razorpay_signature
                })

                alert(res.data.status)
            },
            prefill: {
                name: "John Doe",
                email: "doejon@example.com",
                contact: "9999999999",
            },
            theme: {
                color: "#61dafb",
            },
        };
		const paymentObject = new window.Razorpay(options)
		paymentObject.open()
	}
```
- The above code is an [async function](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Statements/async_function) that calls the `loadScript()` function and passes the Razorpay script `src`.
- The function then makes a POST request to a route(`http://127.0.0.1:8000/createOrder/`) on the server to create an [order](https://razorpay.com/docs/api/orders/#create-an-order) and also sends the price of the selected product. This POST request returns the `amount`, `currency`, and the `order_id`.
- We then create an `options` object and provide it with all the data required to complete the transaction.
- For a successful payment, the check out will return `razorpay_payment_id`, `razorpay_order_id`, and `razorpay_signature`. These values can be accessed inside the handler property in the `options` object and can be used to verify the transaction in the back-end.
- In the option object, we also include the `theme` which defines the UI's color and the `prefill` which to pass user information that will be used in the form.

Your `App.js` file should have the following code:
```js
import axios from 'axios';
import { useState, useEffect } from 'react'
import './App.css'
import logo from './logo.svg'

function loadScript(src) {
	return new Promise((resolve) => {
		const script = document.createElement('script')
		script.src = src
		script.onload = () => {
			resolve(true)
		}
		script.onerror = () => {
			resolve(false)
		}
		document.body.appendChild(script)
	})
}

function App() {
    const [productDetails, setProductDetails] = useState()
    const [selectedItemAmount, setSelectedItemAmount] = useState()

    useEffect(() => {
        getProduct()
    }, [])

    const getProduct = () => {
        return axios
        .get(`https://fakestoreapi.com/products/${Math.floor(Math.random() * 10) + 11}`)
        .then((res) => {
            setProductDetails(res.data)
            setSelectedItemAmount((res.data.price * 75.61 * 100).toFixed(2))
        })
        .catch((err) => console.log(err))
    }

    async function displayRazorpay() {
		const res = await loadScript('https://checkout.razorpay.com/v1/checkout.js')

		if (!res) {
			alert('Failure loading the Razorpay SDK. PLease make sure you are connected to the internet')
			return
		}
    
    const orderData = await axios.post('http://127.0.0.1:8000/createOrder/', {
      amount: selectedItemAmount
    })

    const { amount, currency, order_id } = orderData.data

    
		const options = {
            key: "<key_id>", // Enter the Key ID generated from the Dashboard
            amount: amount.toString(),
            currency: currency,
            name: "Test Company",
            description: "Test Transaction",
            image: logo,
            order_id: order_id,
            handler: async function (response) {
                const razorpay_paymentId = response.razorpay_payment_id
                const razorpay_orderId = response.razorpay_order_id
                const razorpay_signature = response.razorpay_signature

                const res = await axios.post('http://127.0.0.1:8000/verifySignature/', {
                  razorpay_paymentId,
                  razorpay_orderId,
                  razorpay_signature
                })

                alert(res.data.status)
            },
            prefill: {
                name: "John Doe",
                email: "doejon@example.com",
                contact: "9999999999",
            },
            theme: {
                color: "#61dafb",
            },
        };
		const paymentObject = new window.Razorpay(options)
		paymentObject.open()
	}
  return (
    <div className="App">
    {
      productDetails && (
        <div className="card">
          <img src={productDetails.image} alt="Denim Jeans" />
          <div className='details'>
            <h1>{productDetails.title.substring(0, 20) + "..."}</h1>
            <p className="price">{"â‚¹ " + (productDetails.price * 75.61).toFixed(2)}</p>
            <p>{productDetails.description.substring(0, 70) + "..."}</p>
            <button onClick={displayRazorpay}>BUY</button>
          </div>
        </div>
      )
    }
  </div> 
  );
}

export default App;
```

### Setting up the Server
Open the `react-django-razorpay` folder we created earlier in terminal and run the commands below to create a [virtual environment](https://docs.python.org/3/tutorial/venv.html) and activate it.
```bash
python3 -m venv razorpay-env

source ./razorpay-env/bin/activate
```
With the virtual environment active, run the commands below to install Django, create a new project, and open it in VS Code.

```bash
python3 -m pip install django

django-admin startproject server

code server
```
Then, create a new app that will handle all the API requests from the front-end using the command below.
```bash
django-admin startapp api
```
Run the commands below to install dependencies that will be needed in the project.
```bash
pip install djangorestframework

python3 -m pip install django-cors-headers

pip install razorpay
```

- djangorestframework - will allow you to create an API with the Django framework.
- django-cors-headers - will allow communication between the React front-end and the Django back-end.
- razorpay - will allow us to perform interactions with the Razorpay API programatically.
#### Modifying `settings.py` File
Modify the `settings.py` file with the code snippets provided below.

For the `INSTALLED_APPS`:
```python
INSTALLED_APPS = [
    'django.contrib.admin',
    'django.contrib.auth',
    'django.contrib.contenttypes',
    'django.contrib.sessions',
    'django.contrib.messages',
    'django.contrib.staticfiles',

    'api.apps.ApiConfig', #registers the api app
    'rest_framework', #registers the django rest framework as dependency
    'corsheaders' #registers corheaders as dependency
]
```

For the `MIDDLEWARE`:
```python
MIDDLEWARE = [
    'django.middleware.security.SecurityMiddleware',
     "corsheaders.middleware.CorsMiddleware", #to listen in on responses
    'django.contrib.sessions.middleware.SessionMiddleware',
    'django.middleware.common.CommonMiddleware',
    'django.middleware.csrf.CsrfViewMiddleware',
    'django.contrib.auth.middleware.AuthenticationMiddleware',
    'django.contrib.messages.middleware.MessageMiddleware',
    'django.middleware.clickjacking.XFrameOptionsMiddleware',
]
```

To whitelist the React front-end, add the following code at the bottom of the `settings.py` file.
```python
CORS_ALLOWED_ORIGINS = [
    "http://localhost:3000",
    "http://127.0.0.1:3000",
]
```

Lastly, replace the code in `server/urls.py` file with the code below to route all the requests to the `api` app we created.
```python
from django.contrib import admin
from django.urls import path, include

urlpatterns = [
    path('admin/', admin.site.urls),
    path('', include('api.urls')),
]
```

#### Working on the Views
Open the `api/views.py` file and modify it with the code below.
```python
from django.shortcuts import redirect
from rest_framework.response import Response
from rest_framework.decorators import api_view
import razorpay


# Create your views here.
@api_view(['POST'])
def createOrder(request):
    global client
    data = request.data

    amount = int(float(data['amount']))

    client = razorpay.Client(auth=("<key_id>", "<key_secret>"))

    data = {"amount" : amount, "currency" : "INR"}
    payment = client.order.create(data=data)

    return Response({'order_id': payment['id'], 'amount': payment['amount'], 'currency':payment['currency']})

@api_view(['POST'])
def verifySignature(request):
    res = request.data

    params_dict = {
        'razorpay_payment_id' : res['razorpay_paymentId'],
        'razorpay_order_id' : res['razorpay_orderId'],
        'razorpay_signature' : res['razorpay_signature']
    }

    # verifying the signature
    res = client.utility.verify_payment_signature(params_dict)

    if res == True:
        return Response({'status':'Payment Successful'})
        
    return Response({'status':'Payment Failed'})
```
In the code above, we have two views:
- `createOrder()` - This view is used to create an order on the server. It has a global variable `client` that is used to create a Razorpay instance. To create a Razorpay instance, we use `razorpay.Client(auth=("<key_id>", "<key_secret>")).` Replace the `key_id` and the `key_secret` with the your key values from the Razorpay dashboard. To create an order, use `client.order.create(data=data)` and pass in the data variable that contains the amount of the item selected from the front-end and the currency used. Then return the `order_id`, `amount`, and `currency` from the order to the front-end.
- `verifySignature()` - This view is used to verify a transaction. After the user makes the payment, the `razorpay_payment_id`, `razorpay_order_id` `razorpay_signature` from the transaction are sent to the server to verify the transaction. Using the `client.utility.verify_payment_signature(params_dict)` to verify return a Boolean `True` or `False`. If it returns `True`, the transaction was successful. 

#### Working on the URLs
Open the `api/urls.py` file and modify it with the code below which exposes the API endpoints.
```py
from django.urls import path
from . import views

urlpatterns = [
    path('createOrder/', views.createOrder),
    path('verifySignature/', views.verifySignature),
]
```

### Testing the Application
To run the Django back-end/server, navigate to the `server` directory and run the command below:
```bash
python3 manage.py runserver
```

To run the React front-end, navigate to the `client` directory and run the command below:
```bash
yarn start
```
This opens the application on `http://localhost:3000/`. Open this URL on the browser and you will be presented with a product as shown below:
![test product](/engineering-education/react-django-razorpay-integration/product.png)

Click on the `BUY` button a payment modal pops up.
![payment modal](/engineering-education/react-django-razorpay-integration/paymentmodal.png)

Upon successful a successful transaction, an alert with `Payment Successful` message pops up.
![success alert](/engineering-education/react-django-razorpay-integration/success.png)

### Payments Log
You can view the received payments on the Razorpay dashboard by clicking on `Transactions` on the left sidebar.
![payments](/engineering-education/react-django-razorpay-integration/payments.png)

To learn about how to use the Razorpay dashboard, click [here](https://razorpay.com/blog/how-to-use-razorpay-dashboard/).


### Conclusion
In this article, you have learned how to:
- Create a Razorpay account.
- Obtain the keys from the dashboard.
- Create an order.
- Verify a signature.
- Check the payment logs.

With this knowledge, you can go ahead and implement the Razorpay payment gateway in your React-Django application.

Happy coding!
